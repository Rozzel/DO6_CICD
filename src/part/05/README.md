# CD: Доставка бинарного файла

## Подготовка продакшен среды

```zsh
ssh-keygen -t rsa -b 2048
base64 -w 0 < id_rsa > id_rsa.base64

touch .ssh/authorized_keys

sudo micro /etc/ssh/sshd_config
PubkeyAuthentication yes
sudo systemctl restart sshd

chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys

sudo chown -R lothostr /usr/local/bin
```

## GitLab UI

```zsh
UI_USERNAME
UI_HOST
UI_SSH_PRIVATE_KEY

lothostr
```

## Передача файлов

```zsh
scp src/cat/main.c lothostr@192.168.64.19:/tmp/s21_cat && \
ssh -t lothostr@192.168.64.19 sudo mv /tmp/s21_cat /usr/local/bin/s21_cat
```

## `.gitlab-ci.yml`
- script: - bash deploy.sh указывает на выполнение его скрипта развёртывания.
- only: - develop означает, что развёртывание происходит только для ветки develop.
- when: manual позволяет запускать этап вручную через интерфейс GitLab.
- allow_failure: false гарантирует, что если этап развёртывания не удаётся, весь пайплайн будет помечен как неудачный.

## `deploy.sh`
Скрипт `Bash` автоматизирует процесс копирования собранных программ (`s21_cat` и `s21_grep`) на удаленный сервер и устанавливает их в директорию `/usr/local/bin`, делая исполняемыми.

### Запрос учетных данных пользователя и сервера

- `read -rp "Введите имя пользователя: " USERNAME` запрашивает имя пользователя и сохраняет введенное значение в переменную `USERNAME`.
- `read -rp "Введите хост: " HOST` запрашивает адрес хоста (сервера) и сохраняет его в переменную `HOST`.
- `read -rsp "Введите пароль: " PASSWORD` запрашивает пароль в "тихом" режиме (`-s`), не отображая ввод на экране, и сохраняет введенное значение в переменную `PASSWORD`.
- После ввода пароля выводится пустая строка (`echo`) для перехода на новую строку в терминале.

- `-r` (raw input): флаг предотвращает обработку обратных слешей (\) как специальных символов. Обычно, в Bash обратный слеш используется для экранирования следующего символа, но с флагом -r, все символы, включая обратный слеш, считываются буквально. Это особенно полезно при вводе строк, которые могут содержать обратные слеши, например, пароли.
- `-s` (silent mode): флаг скрывает вводимые символы, делая их невидимыми на экране терминала. Он часто используется при запросе паролей или другой конфиденциальной информации, чтобы предотвратить их отображение и возможное перехватывание посторонними лицами.
- `-p` (prompt): после флага -p следует текст приглашения к вводу, который отображается пользователю перед тем, как команда read начнет считывание данных из стандартного ввода. Это позволяет делать интерфейс скрипта более понятным и дружелюбным, ясно указывая, какие данные от пользователя ожидаются.

### `ssh-copy-id`

Команда `ssh-copy-id` используется для автоматического копирования публичного ключа SSH на удалённый сервер, что позволяет впоследствии подключаться к серверу без ввода пароля. Это удобный способ настроить безопасное подключение к серверам через SSH без необходимости каждый раз вручную копировать и вставлять ключи. Вот как работает эта команда:

```zsh
ssh-copy-id [пользователь@]хост
```

Перед использованием `ssh-copy-id` необходимо убедиться, что на локальном компьютере сгенерирована пара ключей SSH (публичный и приватный).

Если они не сгенерированы: `ssh-keygen`.

Команда `ssh-copy-id` берёт публичный ключ из локального компьютера и копирует его в файл `~/.ssh/authorized_keys` на указанном удалённом сервере. Этот файл `authorized_keys` на сервере содержит публичные ключи всех пользователей, которым разрешён безпарольный доступ.

После копирования публичного ключа на сервер, SSH-клиент на компьютере автоматически предлагает серверу соответствующий приватный ключ. Если предложенный приватный ключ соответствует одному из публичных ключей в файле `authorized_keys` на сервере, сервер разрешает вход без запроса пароля.

```zsh
ssh-copy-id username@hostname
```
> Команда пытается подключиться к серверу `hostname` с именем пользователя `username`. Вас могут попросить ввести пароль пользователя `username` на сервере `hostname` для выполнения копирования ключа. После успешного копирования ключа вы сможете подключаться к `hostname` под пользователем `username` без необходимости вводить пароль. 

Это делает процесс подключения не только более удобным, но и повышает безопасность, так как аутентификация по ключу считается более надёжной, чем аутентификация по паролю.

### Компиляция программ

- Переход в директорию `cat` и компиляция программы `s21_cat` с помощью `make`. Если директория `cat` не существует (проверка `|| exit 1`), скрипт завершается с ошибкой.
- Аналогичные действия выполняются для программы `s21_grep` в директории `grep`.

### Копирование скомпилированных программ на удаленный сервер

- Команда `scp` используется для безопасного копирования файла `s21_cat` во временную директорию `/tmp` на удаленном сервере. В случае неудачи выводится сообщение об ошибке и скрипт завершается с кодом `1`. Аналогичная операция выполняется для `s21_grep`.

### Установка программ в директорию `/usr/local/bin` на удаленном сервере:

- Выполняется подключение по SSH к удаленному серверу с выделением псевдотерминала (`-t`) для выполнения команд. Это необходимо для `sudo`, требующего терминал для ввода пароля.
- `echo '"$PASSWORD"' | sudo -S mv /tmp/s21_cat '"$DEST_PATH"'/s21_cat` передает пароль в `sudo` через стандартный ввод (`-S`), перемещая файл из `/tmp` в `/usr/local/bin` и затем делая его исполняемым (`chmod +x`).
- В случае ошибки при выполнении любой из команд (`mv` или `chmod`) скрипт выводит сообщение об ошибке и завершается с кодом `1`.
> Тесты которые делал для написания итогового скрипта.
Аналогичные действия выполняются для файла `s21_grep`.
